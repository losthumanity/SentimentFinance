# ============================================================================
# AWS SAM Template for Sentiment Finance Pipeline
# Creates EventBridge, Lambda, RDS MySQL, VPC, and necessary IAM roles
# ============================================================================

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Sentiment Finance - Event-driven financial news sentiment analysis pipeline'

Parameters:
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment name'
  
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: 'Password for RDS MySQL database'
    Default: 'TempPassword123!'
  
  NewsAPIKey:
    Type: String
    NoEcho: true
    Description: 'API key for news data source'
    Default: 'your-news-api-key-here'

Globals:
  Function:
    Timeout: 300
    MemorySize: 512
    Runtime: python3.11
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment

Resources:
  # ============================================================================
  # VPC and Networking for RDS
  # ============================================================================
  
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-2'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.3.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet-1'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-routes'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-routes'

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  # ============================================================================
  # RDS MySQL Database
  # ============================================================================
  
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: 'Subnet group for RDS MySQL'
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-db-subnet-group'

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group for RDS MySQL'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-db-sg'

  MySQLDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${AWS::StackName}-mysql'
      DBInstanceClass: 'db.t3.micro'
      Engine: 'mysql'
      EngineVersion: '8.0.35'
      MasterUsername: 'admin'
      MasterUserPassword: !Ref DBPassword
      AllocatedStorage: 20
      StorageType: 'gp2'
      DBName: 'sentiment_finance'
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      MultiAZ: false
      PubliclyAccessible: false
      StorageEncrypted: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-mysql'

  # ============================================================================
  # Lambda Function and Security
  # ============================================================================
  
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group for Lambda function'
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-lambda-sg'

  SentimentFinanceLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-sentiment-pipeline'
      CodeUri: ../src/
      Handler: lambda_handler.lambda_handler
      Runtime: python3.11
      Timeout: 900
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          DB_HOST: !GetAtt MySQLDatabase.Endpoint.Address
          DB_PORT: !GetAtt MySQLDatabase.Endpoint.Port
          DB_NAME: 'sentiment_finance'
          DB_USER: 'admin'
          DB_PASSWORD: !Ref DBPassword
          NEWS_API_KEY: !Ref NewsAPIKey
          NEWS_API_BASE_URL: 'https://newsapi.org/v2'
          LOG_LEVEL: 'INFO'
      Policies:
        - VPCAccessPolicy: {}
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'
      Events:
        ScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: 'rate(15 minutes)'
            Input: |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event"
              }

  # ============================================================================
  # EventBridge Rule (Alternative to SAM Schedule)
  # ============================================================================
  
  SentimentAnalysisScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${AWS::StackName}-sentiment-schedule'
      Description: 'Trigger sentiment analysis every 15 minutes'
      ScheduleExpression: 'rate(15 minutes)'
      State: 'ENABLED'
      Targets:
        - Arn: !GetAtt SentimentFinanceLambda.Arn
          Id: 'SentimentAnalysisTarget'
          Input: |
            {
              "source": "aws.events",
              "detail-type": "Scheduled Event",
              "event_type": "scheduled"
            }

  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref SentimentFinanceLambda
      Principal: 'events.amazonaws.com'
      SourceArn: !GetAtt SentimentAnalysisScheduleRule.Arn

  # ============================================================================
  # CloudWatch Log Group
  # ============================================================================
  
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${SentimentFinanceLambda}'
      RetentionInDays: 14

  # ============================================================================
  # Systems Manager Parameters for Configuration
  # ============================================================================
  
  DBEndpointParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${AWS::StackName}/db/endpoint'
      Type: 'String'
      Value: !GetAtt MySQLDatabase.Endpoint.Address
      Description: 'RDS MySQL endpoint'

  DBPortParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${AWS::StackName}/db/port'
      Type: 'String'
      Value: !GetAtt MySQLDatabase.Endpoint.Port
      Description: 'RDS MySQL port'

Outputs:
  VPCId:
    Description: 'VPC ID'
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  DatabaseEndpoint:
    Description: 'RDS MySQL Endpoint'
    Value: !GetAtt MySQLDatabase.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseEndpoint'

  DatabasePort:
    Description: 'RDS MySQL Port'
    Value: !GetAtt MySQLDatabase.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-DatabasePort'

  LambdaFunctionArn:
    Description: 'Lambda Function ARN'
    Value: !GetAtt SentimentFinanceLambda.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaArn'

  LambdaFunctionName:
    Description: 'Lambda Function Name'
    Value: !Ref SentimentFinanceLambda
    Export:
      Name: !Sub '${AWS::StackName}-LambdaName'

  EventBridgeRuleArn:
    Description: 'EventBridge Rule ARN'
    Value: !GetAtt SentimentAnalysisScheduleRule.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EventRuleArn'